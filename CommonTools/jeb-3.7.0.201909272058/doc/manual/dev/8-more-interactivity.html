<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="PNF Software">
        <link rel="canonical" href="https://www.pnfsoftware.com/jeb2/manual/dev/8-more-interactivity.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Part 8: More on Interactivity - JEB Decompiler</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="https://www.pnfsoftware.com/jeb">JEB Decompiler</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../index.html">Getting Started</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using JEB <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../actions.html">Common Actions</a>
</li>
                                    
<li >
    <a href="../views.html">Common Views</a>
</li>
                                    
<li >
    <a href="../decompiling.html">Decompiling</a>
</li>
                                    
<li >
    <a href="../debugging.html">Debugging</a>
</li>
                                    
<li >
    <a href="../android.html">Android App Analysis</a>
</li>
                                    
<li >
    <a href="../android-debugging.html">Android App Debugging</a>
</li>
                                    
<li >
    <a href="../native.html">Native Code Analysis</a>
</li>
                                    
<li >
    <a href="../native-debugging.html">Native Code Debugging</a>
</li>
                                    
<li >
    <a href="../webassembly.html">WebAssembly Modules</a>
</li>
                                    
<li >
    <a href="../ethereum.html">Ethereum Smart Contracts</a>
</li>
                                    
<li >
    <a href="../misc.html">Miscellaneous</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing with JEB <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="introducing-jeb-extensions.html">Introducing JEB Extensions</a>
</li>
                                    
<li >
    <a href="writing-client-scripts.html">Writing Client Scripts</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Writing Parsers (Tutorial Series)</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="1-getting-started-with-parsers.html">Part 1: Getting Started with Parsers</a>
</li>
            
<li >
    <a href="2-creating-simple-parser.html">Part 2: Creating a Simple Parser</a>
</li>
            
<li >
    <a href="3-documents-delegation.html">Part 3: Documents and Delegation</a>
</li>
            
<li >
    <a href="4-tables-trees.html">Part 4: Tables and Trees</a>
</li>
            
<li >
    <a href="5-development-tips.html">Part 5: Development Tips</a>
</li>
            
<li >
    <a href="6-releasing-plugin.html">Part 6: Releasing a Plugin</a>
</li>
            
<li >
    <a href="7-unit-interactivity.html">Part 7: Interactivity</a>
</li>
            
<li class="active">
    <a href="8-more-interactivity.html">Part 8: More on Interactivity</a>
</li>
    </ul>
  </li>
                                    
<li >
    <a href="writing-engines-plugins.html">Writing Engines Plugins</a>
</li>
                                    
<li >
    <a href="writing-front-ends.html">Writing Front-Ends</a>
</li>
                                    
<li >
    <a href="other-resources.html">Additional Resources</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Configuration <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../settings.html">Settings</a>
</li>
                                    
<li >
    <a href="../client-configuration.html">Client Configuration</a>
</li>
                                    
<li >
    <a href="../engines-configuration.html">Engines Configuration</a>
</li>
                                    
<li >
    <a href="../floating.html">Floating Controller</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../faq.html">FAQ</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="7-unit-interactivity.html">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="writing-engines-plugins.html">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#more-on-interactivity">More on Interactivity</a></li>
            <li><a href="#user-actions">User Actions</a></li>
            <li><a href="#navigation">Navigation</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><em>JEB Plugin Development Tutorial part 8/8</em></p>
<h1 id="more-on-interactivity">More on Interactivity<a class="headerlink" href="#more-on-interactivity" title="Permanent link">&para;</a></h1>
<p>The source code for part 8 of this sample plugin is located on GitHub:</p>
<ul>
<li>Clone <a href="https://github.com/pnfsoftware/jeb2-plugindemo-js">this repo</a>: <code>git clone https://github.com/pnfsoftware/jeb2-plugindemo-js.git</code></li>
<li>Switch to the <em>tutorial8</em> branch: <code>git checkout tutorial8</code></li>
</ul>
<h2 id="user-actions">User Actions<a class="headerlink" href="#user-actions" title="Permanent link">&para;</a></h2>
<h3 id="canexecute">CanExecute<a class="headerlink" href="#canexecute" title="Permanent link">&para;</a></h3>
<p>JEB provides the ability to interact with the units. Those units are called <em>interactive units</em>.</p>
<p>The simplest way to interact with units is through <a href="../actions.html">well-known actions</a>.</p>
<p><a href="img/Plugin8-01.png"><img alt="" src="img/Plugin8-01.png" /></a></p>
<p>The actions have to be implemented by the plugin developer. An action has an <a href="https://www.pnfsoftware.com/jeb/apidoc/reference/com/pnfsoftware/jeb/core/actions/ActionContext.html">ActionContext</a> as a parameter, which allows the plugin to retrieve:</p>
<ul>
<li>the action id: one defined in the <a href="https://www.pnfsoftware.com/jeb/apidoc/reference/com/pnfsoftware/jeb/core/actions/Actions.html">Actions</a> class. It indicates which action is involved (Comment, Rename...)</li>
<li>the address: the current position in the document</li>
<li>the item id: we will discuss it later.</li>
</ul>
<p>First, why are all these actions grayed out? Because <code>canExecuteAction()</code> does not return true - yet.</p>
<pre><code class="java">public boolean canExecuteAction(ActionContext actionContext) {
    logger.info(&quot;%s called with address %s and actionId %d&quot;,
            &quot;canExecuteAction&quot;, actionContext.getAddress(), actionContext.getActionId());
    return false;
}
</code></pre>

<p>As you can see in the logs, this method is called each time you move the caret in the document. What if we try to return true instead of false?</p>
<p><a href="img/Plugin8-02.png"><img alt="" src="img/Plugin8-02.png" /></a></p>
<p>As expected, all actions become clickable.</p>
<p>Note that you can also use the toolbar icons or, even better, the keyboard shortcuts.</p>
<p><a href="img/Plugin8-03.png"><img alt="" src="img/Plugin8-03.png" /></a></p>
<p>Nothing happens when you click on any action: it is up to the plugin developer to implement the desired feature.</p>
<p>We will implement a simple action: <strong>renaming of a String</strong>. (Note: we could as well rename functions, methods, variables... but we need to check in the model where they are used to replace all occurrences, consistently. The added complexity is out-of-scope in this API introduction tutorial.)</p>
<p>First, we need to activate the rename feature when we are on a String:</p>
<blockquote>
<p><strong>Assignment 1</strong>: Save the string references and test if the caret in on a String.</p>
</blockquote>
<h3 id="prepareexecution">PrepareExecution<a class="headerlink" href="#prepareexecution" title="Permanent link">&para;</a></h3>
<p>When clicking on the "Rename" action button, the method <code>IInteractiveUnit.prepareExecution()</code> is called. Its goal is to prepare the execution of the code and, in the case of renaming, it also provides the initial value that we want to edit: it is called before displaying the following pop up:</p>
<p><a href="img/Plugin8-04-2.png"><img alt="" src="img/Plugin8-04-2.png" /></a></p>
<p>You need to return true in the prepareExecution method to indicate that the processing should continue.</p>
<p>The <code>prepareExecution</code> method has one more parameter of type <a href="https://www.pnfsoftware.com/jeb/apidoc/reference/com/pnfsoftware/jeb/core/actions/IActionData.html">IActionData</a>. To fill up the name field, we need to retrieve the correct Action Data type:</p>
<p><a href="img/Plugin8-05.png"><img alt="" src="img/Plugin8-05.png" /></a></p>
<p>Use <a href="https://www.pnfsoftware.com/jeb/apidoc/reference/com/pnfsoftware/jeb/core/actions/ActionRenameData.html">ActionRenameData</a> to prefill the rename field with its current value.</p>
<pre><code class="java">public boolean prepareExecution(ActionContext actionContext, IActionData actionData) {
    if(actionContext.getActionId() == Actions.RENAME) {
        StringLiteral string = getElementAt(actionContext.getAddress(), strings);
        if(string != null) {
            ((ActionRenameData)actionData).setCurrentName(string.getValue());
            return true;
        }
    }
    return false;
}
</code></pre>

<p>Note that IActionData embeds a generic map to pass discretionary objects from <code>prepareExecution</code> to <code>executeAction</code> method.</p>
<h3 id="executeaction">ExecuteAction<a class="headerlink" href="#executeaction" title="Permanent link">&para;</a></h3>
<p>The executeAction method is the last step: it performs the action and modifies the model.</p>
<p>What should we modify now?</p>
<ul>
<li><code>IInput</code>: this is a pointer to original file, it makes no sense.</li>
<li><code>AstRoot</code>: this is our kind-of model, but there is no way to retrieve the input data (the toString() method has a specific implementation and the toSource() auto-formats and remove comments.</li>
</ul>
<p><code>IUnit</code> is the central part of your plugin: it is responsible for updating the model and keep coherence regarding all its document. But there is something wrong with the initial design: we don't save a reference Document in the Unit.</p>
<p>Documents shall at least work with the same object as IUnit, and at least have a reference on their IUnit in order to retrieve the data (this is a good practice in JEB).</p>
<p>Therefore, we will now modify our unit to keep references of all lines (using a List<String>).
One problem that will remain is the mandatory conversion at the <code>ITextDocumentPart</code> level:</p>
<pre><code class="java">public List&lt;? extends ILine&gt; getLines
</code></pre>

<p>The <code>getLines</code> method is called each time you scroll/move around the document, so it would be too costly to recalculate the list of ILines each time it is called. It must be buffered and refreshed on changes: the unit must notify its Documents when the model changes.</p>
<p>To make notifications work, you must:</p>
<ul>
<li>Register the notified element:</li>
</ul>
<pre><code class="java">public class JavascriptDocument extends EventSource implements ITextDocument, IEventListener {
    public JavascriptDocument(JavascriptUnit unit) {
        this.unit = unit;
        unit.addListener(this);
        refreshPart();
    }

    // ...

    public void onEvent(IEvent e) {
        if(e.getType() == J.UnitChange) {
            refreshPart();
            this.notifyListeners(e);
        }
    }
}
</code></pre>

<ul>
<li>Call the notify method in the executeAction method (on success):</li>
</ul>
<pre><code class="java">notifyListeners(new JebEvent(J.UnitChange));
</code></pre>

<blockquote>
<p>Refer to the technical draft <a href="https://docs.google.com/document/d/1PFCD1GgFrRgs-XqCGUyLcrGVenCPq8Ab7DPBaJodXeM/pub">"Staying informed of unit changes"</a> for more details about unit changes tracking within documents.</p>
<p><strong>Assignment 2</strong>: Finish the renaming implementation.</p>
</blockquote>
<h2 id="navigation">Navigation<a class="headerlink" href="#navigation" title="Permanent link">&para;</a></h2>
<p>JEB natively manages navigation feature with four predefined actions selectable from menu or directly with shortcuts:</p>
<p><a href="img/Plugin8-06.png"><img alt="" src="img/Plugin8-06.png" /></a></p>
<ul>
<li><em>Jump To</em>: move caret to a specific address. It uses the <code>ITextDocument.addressToCoordinates()</code> that we already implemented for Notifications.</li>
<li><em>Navigate Forward / Navigate Backward</em>: move caret to the previous/next position (caret position history is saved each time you jump)</li>
<li><em>Follow</em>: jump to an address bound to the current element. The best example is on a function call: you can jump to its definition</li>
</ul>
<blockquote>
<p><strong>Assignment 3</strong>: Implement Jump To for function names</p>
</blockquote>
<p>Now, let's look at Follow. We can see that it is active only when we set the caret on strings, var, function... this is because the Follow feature is bound to Items, more precisely, the <a href="https://www.pnfsoftware.com/jeb/apidoc/reference/com/pnfsoftware/jeb/core/output/IActionableItem.html">IActionableItem</a>.</p>
<p>When clicking on <em>Follow</em>, if the caret is positioned on an Item, the function <code>IInteractiveUnit.getAddressOfItem()</code> is called.</p>
<blockquote>
<p><strong>Assignment 4</strong>: Implement Follow for function name (it should work on the latest b();)</p>
</blockquote>
<p>A solution to the assignments can be found by checking out the branch <code>tutorial8</code> of the <a href="https://github.com/pnfsoftware/jeb2-plugindemo-js">sample code</a>. </p>
<p><strong>Back to <a href="1-getting-started-with-parsers.html">Part 1</a></strong></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>JEB &copy; <a href="https://www.pnfsoftware.com">PNF Software, Inc.</a> 2015, 2019 - Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
